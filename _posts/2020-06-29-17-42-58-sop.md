# SOP迁移想法关键节点记录

## sopengine中的引擎可能需要修改


## 3. SOP动作关键节点链路梳理

XSPACE 已有动作节点

1. [x] 留言
2. [x] 外呼
3. [x] 发短信
4. [x] 采纳SOP判责结论
5. [x] 不采纳SOP判责结论
6. [X] 代叫运力(裹裹呼叫运力)
7. [x] 取消裹裹订单
8. [X] 申请菜鸟小二介入
9. [x] 咨询工单完结
10. [x] 工单挂起
11. [x] 发起投诉
12. [x] 修改上门时间
13. [x] 添加驿站白名单
14. [x] 取消驿站白名单
15. [ ] 下发CP举证
16. [ ] 转交CP(没有要求)
17. [ ] 评价sop(没有要求)

### 3.2 处理组件

1. [x] 留言
2. [x] 外呼
3. [ ] 发短信
4. [ ] 采纳SOP判责结论
5. [ ] 不采纳SOP判责结论
6. [X] 代叫运力(裹裹呼叫运力)
7. [ ] 取消裹裹订单
8. [X] 申请菜鸟小二介入
9. [x] 咨询工单完结
10. [x] 工单挂起
11. [x] 发起投诉
12. [x] 修改上门时间
13. [ ] 添加驿站白名单
14. [ ] 取消驿站白名单
15. [x] 下发CP举证

## 关键代码函数调用链

### 2.1 获取联系人数据
获取联系人的数据;`/getOutBound`

```plantuml
@startuml
title getOutBound 主要调用时序图

' 主要类
box "xspace"
'com.cainiao.gaea.web.controller.casecenter.SopActionController
collections "SopActionManager" as SopActionManager
'com.cainiao.gaea.xspacedesk.biz.manager.casecenter.CaseQueryManager
collections "CaseQueryManager" as CaseQueryManager1
end box

box "gaea application" #LightGreen

' com.cainiao.gaea.application.biz.service.common.CaseQueryServiceImpl
collections "CaseQueryServiceImpl" as CaseQueryService 
' com.cainiao.gaea.application.biz.service.csop.SopActionPerformServiceImpl
collections "SopActionPerformServiceImpl" as SopActionPerformService
' com.cainiao.gaea.application.biz.manager.common.CaseCommonDealManager
collections "CaseCommonDealManager" as CaseCommonDealManager

'com.cainiao.gaea.application.biz.manager.common.CaseQueryManager
collections "CaseQueryManager" as CaseQueryManager2
'com.cainiao.gaea.application.dal.mybatis.CaseMapper
collections "CaseMapper" as CaseMapper
'com.cainiao.gaea.application.dal.mybatis.CaseExtFieldsMapper
collections "CaseExtFieldsMapper" as CaseExtFieldsMapper

end box

box "gaea-platfrom" 
' com.cainiao.gaea.platform.bizorder.hsf.provider.BizOrderReadServiceImpl
collections "BizOrderReadServiceImpl" as BizOrderReadService
' com.cainiao.gaea.platform.view.core.service.ViewDisplayServiceImpl
collections "ViewDisplayServiceImpl" as ViewDisplayService
' .AccountServiceImpl
collections "AccountServiceImpl" as AccountService
'
collections "DataSetExecuteServiceImpl" as DataSetExecuteService 
'
collections "StationReadServiceImpl" as StationReadService
end box


box "taobao.loc.service" #556
collections "LocReadService" as LocReadService
end box
box "alibaba.cainiao.stationplatform" #895
collections "StationOrderService" as StationOrderService
end box
' 流程操作 ===start===
[o-> SopActionManager: getOutBoundInfo(Long caseId,User loginUser)
activate SopActionManager
== 获取case信息 ==
SopActionManager -> CaseQueryManager1: getCaseDetailInfoByCaseId(Long caseId)
activate CaseQueryManager1

CaseQueryManager1 -> CaseQueryService : getCaseDetailByCaseId\n(GetCaseDetailByCaseIdRequest request)

activate CaseQueryService
CaseQueryService -> CaseQueryManager2 : getCaseById(BizContext context)
note right of CaseQueryService
BizContext 和 GetCaseDetailByCaseIdRequest
的主要内容都是caseId
end note
activate  CaseQueryManager2

CaseQueryManager2 ->  CaseMapper: queryById(Long caseId)
activate CaseMapper
return CaseDO
' 根据caseId查询所有extFields
CaseQueryManager2-> CaseExtFieldsMapper: queryByCaseId(Long caseId)
activate CaseExtFieldsMapper
return List<CaseExtFieldDO> caseExtFieldDOs

CaseQueryManager2 -> CaseQueryManager2 : caseConvertor\n .caseDOConvertToCaseBaseInfo(caseDO,caseExtFieldDOs)
activate CaseQueryManager2 #DarkSalmon
deactivate 
return CaseBaseInfo caseBaseInfo

CaseQueryService ->  BizOrderReadService  : getBizOrder(LogisticsContext var1)
activate BizOrderReadService
return Result<BizOrder> bizOrderResult

note right of CaseQueryService
获取工单信息
主要由gaea-platform-spi提供接口
com.cainiao.gaea.platform.bizorder.hsf.provider.BizOrderReadServiceImpl
提供具体的服务实现
end note

CaseQueryService ->CaseQueryService: replaceBiFeeWithSnapshot(caseBaseInfo, bizOrder);
activate CaseQueryService #DarkSalmon
deactivate CaseQueryService

return Result<CaseDetailInfo> 
note left of CaseQueryManager1
CaseDetailInfo = BizOrder + CaseBaseInfo
end note

return RpcResult<CaseDetailInfo> \n caseDetailInfoRpcResult

== 查找viewConfigId ==


SopActionManager -> ViewDisplayService : listDefaultDisplayView(viewRequest)
activate ViewDisplayService
note right of SopActionManager
viewRequest 主要包含
caseBaseInfo中的
bizLineId,type
categoryId,customerRole
相关信息
end note 
return Result<DefaultDisplayViewDTO> viewDTOResult

== 获取外呼信息 ==

SopActionManager -> SopActionPerformService : getOutboundInfo(GetOutBoundCallByConditionRequest var1)
activate SopActionPerformService
SopActionPerformService -> CaseCommonDealManager : getOutBoundCallByCondition(BizContext context)
activate CaseCommonDealManager

CaseCommonDealManager -> CaseQueryManager2 :  getCaseById(BizContext context)

note right of CaseCommonDealManager
调用内容
和上文相同
不做过多叙述
end note
activate CaseQueryManager2
return CaseBaseInfo caseBaseInfo
' 获取热线
CaseCommonDealManager -> CaseCommonDealManager : getNumberListByKey()
activate CaseCommonDealManager #DarkSalmon
deactivate CaseCommonDealManager

' 获取被叫号码

' 获取用户联系方式
CaseCommonDealManager -> ViewDisplayService : listDisplayedElement(QueryDisplayElementListRequest var1)
activate ViewDisplayService
return Result<List<String>> result 
note over ViewDisplayService 
获取展示元素列表
end note
CaseCommonDealManager -> AccountService : getAccountById()
activate AccountService
return Result<Account> accountResult

note right of AccountService
主要获取
用户电话和手机
end note

' 收件人和裹裹寄件联系方式

CaseCommonDealManager -> BizOrderReadService : getBizOrder(LogisticsContext var1)
activate BizOrderReadService 
return Result<BizOrder> bizOrderResult
note right of BizOrderReadService
主要获取
收件人电话
收件人手机
end note

' 获取裹裹订单信息
CaseCommonDealManager -> DataSetExecuteService : executeDataSet(@Valid DataSetExecuteRequest var1)
activate DataSetExecuteService
return Map<String, String> guoguoInfo

note right of DataSetExecuteService
主要获取
寄件人手机
下单人手机
顺丰电话
小件员电话
end note

' 驿站订单联系方式
CaseCommonDealManager -> StationReadService : queryStationOrderByOrderCode(String bizOrderCode)
activate StationReadService
return StationOrderInfoDTO 
note right of StationReadService
驿站收件人电话
收件人手机
end note 
' 驿站站点联系方式

CaseCommonDealManager -> StationReadService : queryStationInfoByOrderCode(String bizOrderCode)
activate StationReadService

StationReadService -> LocReadService : queryLogisticsOrderByCode
activate LocReadService
return SingleResultDO<LocOrderDO> 
StationReadService -> StationOrderService :queryStationOrderByOrderId
activate StationOrderService

return StationResultDTO<List<StationOrderDTO>>


return StationInfoDTO
note right of StationReadService
驿站站点电话
驿站手机
end note

' 工单创建人联系人电话
CaseCommonDealManager -> ViewDisplayService : listDisplayedElement(QueryDisplayElementListRequest )
activate ViewDisplayService
return List<String> elementList

return Result<OutBoundCallDTO> result
note right of SopActionPerformService
各种电话
end note 
return Result<OutBoundCallDTO> outBoundCallDTOResult

return RpcResult<OutBoundCallVO> res

' 流程操作 ====end===
@enduml
```

### 2.2 外呼的主要流程时序图

外呼的主要链接api: `/action/call`
```plantuml
@startuml
title 外呼主要流程时序图
' xspace
box xspace
collections "SopActionController" as SopActionController
collections "SopActionManager" as SopActionManager
'
collections "CaseQueryManager" as CaseQueryManager

end box
' gaea-apllication

box gaea-application #LightGreen
collections "CaseQueryManagerImpl"  as CaseQueryService
collections "MyTaskMapper" as MyTaskMapper
collections "SopActionPerformServiceImpl" as SopActionPerformService
collections "SopActionPerformManager" as SopActionPerformManager
collections "ActionManager" as ActionManager
end box

box "cxdc.xspace.account" #LightBlue
collections "CenterXspaceServicerService" as CenterXspaceServicerService
end box

box "xspacehotline" #Light
collections "XspaceHotlineCommonService" as XspaceHotlineCommonService
end box

== 查询任务信息 ==
SopActionController -> SopActionManager : call()
activate SopActionManager
'获取TaskId
SopActionManager -> CaseQueryManager : getActivateTaskBycaseId()
activate CaseQueryManager

CaseQueryManager -> CaseQueryService : listActiveTaskByCaseId
activate CaseQueryService

CaseQueryService -> MyTaskMapper : queryIdByCaseId
activate MyTaskMapper
return List<Long> taskIds
CaseQueryService -> MyTaskMapper : queryByIdsAndStatuses
activate MyTaskMapper
return List<TaskDO>

return List<TaskInfo>
return Result<List<TaskInfo>>
== 执行外呼 ==
' 执行外呼
SopActionManager -> SopActionPerformService : executeOutbound
activate SopActionPerformService

SopActionPerformService -> SopActionPerformManager : call
activate SopActionPerformManager
SopActionPerformManager -> CenterXspaceServicerService : getServicerByUicId
activate CenterXspaceServicerService
note right of CenterXspaceServicerService
主要获取
serviceId
hotLineNumber
calledNumber
end note
return XspaceServicerDO
SopActionPerformManager -> XspaceHotlineCommonService : sendCommandToXspace
note right of XspaceHotlineCommonService
执行命令
end note
activate XspaceHotlineCommonService
return Result<JSONObject> commandToXspace
SopActionPerformManager -> ActionManager : addAction
' 存储动作
activate ActionManager 
note right of ActionManager
添加动作记录
end note
deactivate
==  ==
return RpcResult<Void>
return RpcResult<Void>
return RpcResult<Void>
@enduml
```

### 2.3 添加外呼动作记录

主要动作链接`/addCallAction`
```plantuml
@startuml
title 添加外呼动作记录

' xspace
box xspace
collections "SopActionController" as SopActionController
collections "SopActionManager" as SopActionManager
'
collections "CaseQueryManager" as CaseQueryManager

end box

' gaea-apllication
box gaea-application #LightGreen
collections "CaseQueryManagerImpl"  as CaseQueryService
collections "MyTaskMapper" as MyTaskMapper
collections "SopActionPerformServiceImpl" as SopActionPerformService
collections "ActionManager" as ActionManager
collections "MessageProvider" as MessageProvider
collections "ActionDAO" as ActionDAO
collections "NotifyAdapterManager" as NotifyAdapterManager
end box

box "taobao.wlb.workplatform"
collections "WorkOrderService" as WorkOrderService
collections "WorkOrderNotifySendService" as WorkOrderNotifySendService
end box

box "taobao.wlb.workplatform1"
'WorkOrderService "WorkOrderService" as WorkOrderService
end box

== 查询任务信息 ==

SopActionController -> SopActionManager : addCallAction
activate SopActionManager
'获取TaskId
SopActionManager -> CaseQueryManager : getActivateTaskBycaseId()
activate CaseQueryManager

CaseQueryManager -> CaseQueryService : listActiveTaskByCaseId
activate CaseQueryService

CaseQueryService -> MyTaskMapper : queryIdByCaseId
activate MyTaskMapper
return List<Long> taskIds
CaseQueryService -> MyTaskMapper : queryByIdsAndStatuses
activate MyTaskMapper
return List<TaskDO>

return List<TaskInfo>
return Result<List<TaskInfo>>


SopActionManager -> SopActionPerformService : addCallAction
activate SopActionPerformService

== 添加动作记录 ==
SopActionPerformService -> ActionManager : addAction
activate ActionManager
ActionManager -> ActionDAO: insert
activate ActionDAO
return Long actionId
ActionManager -> MessageProvider : sendActionMessage
activate MessageProvider
' 主要是发送处理动作信息
MessageProvider -> NotifyAdapterManager : notifySaveActionAdapter
activate NotifyAdapterManager 
' 查询工单
NotifyAdapterManager -> WorkOrderService: querySimpleById
activate WorkOrderService
return WorkOrderDTO
NotifyAdapterManager ->  WorkOrderNotifySendService : sendSaveActionMessage
activate WorkOrderNotifySendService
deactivate WorkOrderNotifySendService
deactivate NotifyAdapterManager
deactivate MessageProvider
return RpcResult<Void>
return RpcResult<Void>

return RpcResult<Void>

@enduml
```
### 2.4 发短信

主要对应的链接:`/action/text`

```plantuml
@startuml
title 发送短信

' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService
collections "NotifyAdapterManager" as NotifyAdapterManager
collections "CaseDistinctDAOImpl" as CaseDistinctDAO
collections "DistinctServiceImpl" as DistinctService

end box

box "gaea-platfrom"

collections "NoticeManager" as NoticeManager
collections "NoticeServiceImpl" as NoticeService
collections "NoticeRecordManager" as NoticeRecordManager
' DataBase "DB" as DB
collections "NoticeSendScheduleTask" as NoticeSendScheduleTask
end box

box "alibaba.dts.client" #LightBlue
collections "GridJobContextImpl" as GridJobContext
end box

autonumber 
[o-> SopActionManager : text
activate SopActionManager
== 查询任务信息 ==
note right of SopActionManager
和呼叫相同，故省略
end note


== 开始发送 ==

SopActionManager -> SopActionPerformService : text
activate SopActionPerformService
SopActionPerformService -> NoticeManager : sendByManuallyTaskAndTemplateId
activate NoticeManager
NoticeManager -> NoticeService : sendByManuallyTaskAndTemplateId
activate NoticeService
NoticeService -> NoticeRecordManager : batchCreateNoticeRecord
activate NoticeRecordManager
note right of NoticeRecordManager
主要是将信息存储到数据库
end note
loop

' NoticeRecordManager -> DB : List<NoticeRecordDO>
activate GridJobContext 
GridJobContext -> NoticeSendScheduleTask : GridJobContext.this
alt 任务刚刚初始化
activate  NoticeSendScheduleTask
NoticeSendScheduleTask -\\ NoticeRecordManager : listNoticeRecordDTO
activate NoticeRecordManager #DarkSalmon
NoticeRecordManager --\\ NoticeSendScheduleTask : List<NoticeRecordDTO>

NoticeSendScheduleTask -> GridJobContext : dispatchTaskList

else 任务完成

NoticeSendScheduleTask -> GridJobContext : dispatchTaskList

NoticeSendScheduleTask -> DistinctService : distinct
activate DistinctService
DistinctService -> CaseDistinctDAO : insert
activate CaseDistinctDAO
return Long 
note left of DistinctService
插入工单case
记录
end note
return Result<Boolean>
NoticeSendScheduleTask -> NoticeRecordManager : updateNoticeRecordById

end alt
deactivate  GridJobContext
end loop
'NoticeSendScheduleTask 
deactivate NoticeRecordManager
deactivate NoticeSendScheduleTask
note right of NoticeSendScheduleTask
定期获取
任务并执行
end note
return NoticeResponse
return Result<NoticeResponse>

return boolean success


== 添加动作记录 ==
note over SopActionPerformService
添加动作
记录和上面相同
省略。。。
end note
== ==
return RpcResult<Void>
return RpcResult<Void> 

@enduml
```

### 2.5 获取收信人列表
主要是根据caseId查询工单信息；主要path：`/listTextReceiver`

```plantuml
@startuml
title 获取收信人列表时序图

' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService
'collections "SopActionPerformManager" as SopActionPerformManager
collections "CaseQueryManager" as CaseQueryManager
collections "CaseMapper" as CaseMapper
collections "CaseExtFieldsMapper" as CaseExtFieldsMapper
collections "OrderSenderStrategy" as OrderSenderStrategy
collections "GuoguoManager" as GuoguoManager
end box

box "gaea-platform" #LightRed
collections "ResourceServiceImpl" as ResourceService
collections "AccountServiceImpl" as AccountService
collections "BizOrderReadService" as BizOrderReadService
collections "StationReadService" as StationReadService
end box

box "taobao.wlb.res.client" #LightBlue 
collections "ResourceReadService" as ResourceReadService
end box

box "cainiao.tdtradeplatform" #899
collections "TdTradeQueryService" as TdTradeQueryService
end box 

box "taobao.loc.service" #556
collections "LocReadService" as LocReadService
end box
box "alibaba.cainiao.stationplatform" #895
collections "StationOrderService" as StationOrderService
end box

' 开始请求
autonumber 
[o-> SopActionManager : listTextReceiver
activate SopActionManager

SopActionManager -> SopActionPerformService:listTextReceiver
activate SopActionPerformService

== 查询工单信息 ==
SopActionPerformService -> CaseQueryManager : getCaseByCaseId
activate CaseQueryManager
CaseQueryManager -> CaseMapper : queryById
activate CaseMapper
return CaseDO
CaseQueryManager -> CaseExtFieldsMapper : queryByCaseId
activate CaseExtFieldsMapper

note right of CaseExtFieldsMapper
获取额
外属性信息
主要是判责
end note

return List<CaseExtFieldDO> feature
' 填充判责信息
alt ParamsUtil.isNotEmpty(feature)
    loop ResponsibilityParty : List<ResponsibilityParty>
        alt responsibilityParty.getRole() == CP
            CaseQueryManager -> ResourceService : getResourceById
            activate ResourceService
            ResourceService -> ResourceReadService : cacheGetResourceById
            activate ResourceReadService
            return ResourceDTO
            return resourceName
        else 其它角色
            CaseQueryManager -> AccountService : getAccountById
            activate AccountService
            return accountName
        end alt
    end loop
end alt

note right of CaseQueryManager
主要提取
判责方
end note

return CaseBaseInfo

note right of SopActionPerformService
主要是获取
bizOrderCode
用来查询电话
end note
' 开始查询工单中不同角色的电话
== 查询各种联系人方式 ==

' 获取订单寄件人
SopActionPerformService -> OrderSenderStrategy :getMobile
activate OrderSenderStrategy
OrderSenderStrategy -> BizOrderReadService : getBizOrder
activate BizOrderReadService
return Result<BizOrder>
return String mobile

' 获取订单收件人
SopActionPerformService -> OrderSenderStrategy :getMobile
activate OrderSenderStrategy
OrderSenderStrategy -> BizOrderReadService : getBizOrder
activate BizOrderReadService
return Result<BizOrder>
return String mobile

' 获取订单下单人

SopActionPerformService -> OrderSenderStrategy :getMobile
activate OrderSenderStrategy
OrderSenderStrategy -> GuoguoManager : getOrderPlacerMobile
activate GuoguoManager
GuoguoManager -> BizOrderReadService :getBizOrder
activate BizOrderReadService
return BizOrder
GuoguoManager -> TdTradeQueryService : queryTdOrderByBuyerIdAndOrderId
activate TdTradeQueryService


return TdOrder
note right of GuoguoManager
主要是获取
ggUserId
accountDomain
end note

GuoguoManager -> AccountService: getAccountById
activate AccountService
return Result<Account>

return String moblie
return String mobile

' 获取驿站手机
SopActionPerformService -> StationReadService : queryStationInfoByOrderCode
activate  StationReadService

StationReadService -> LocReadService : queryLogisticsOrderByCode
activate LocReadService
return SingleResultDO<LocOrderDO> 
StationReadService -> StationOrderService :queryStationOrderByOrderId
activate StationOrderService

return StationResultDTO<List<StationOrderDTO>>

return stationInfoDTOResult

' note right of SopActionManager
' 和呼叫相同，故省略
' end note
==  ==
return Result<List<ContactDTO>>
return RpcResult<List<ContactVO>>
@enduml
```

### 2.6 采纳判责

根据处理实例；采纳判责；主要请求path:`/accpetJudge`；主要输入是`CaseDealEntity`

```plantuml
@startuml
title 采纳判责流程调用图

' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService

collections "MyTaskMapper" as MyTaskMapper
collections "SopJudgeManager" as SopJudgeManager

end box


box "sop-engine" #LightBlue
collections "SopRuntimeService" as SopRuntimeService
end box



' 开始流程
[o-> SopActionManager : acceptJudge
activate SopActionManager
SopActionManager -> SopActionPerformService : accpetJudge
activate SopActionPerformService
SopActionPerformService -> SopRuntimeService : getInstanceBySid
activate SopRuntimeService
return Result<SopInstanceDTO>
SopActionPerformService -> MyTaskMapper : queryActiveTaskByCaseId
activate MyTaskMapper
note right of MyTaskMapper
详细步骤
与呼叫相同
故省略
end note
return List<TaskDO> tasks

SopActionPerformService -> SopJudgeManager : sopJudge
activate SopJudgeManager 
return Result 
SopActionPerformService -> SopRuntimeService:updateSopExecutionInstance 
activate SopRuntimeService
return Result<Boolean>
return Result<Void> result

return RpcResult<Void>

@enduml
```

### 2.7 不采纳判责

主要请求path:`/rejectJudge`;输入参数:sessionId、caseId、memo

与采纳判责基本相同。不过多了工单执行动作的记录。上面调用流程详细。不做过多记录

### 2.8 取消裹裹订单
主要请求path:`/cancelGuoguo`；输入参数:caseId


```plantuml
@startuml
title 取消裹裹订单流程调用图
' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService

end box


box "cainiao.tdtradeplatform" #899
collections "OrderWriteService" as OrderWriteService
end box 

' 开始流程
[o-> SopActionManager : cancelGuoguo
activate SopActionManager
SopActionManager -> SopActionPerformService : cancelGuoguo
activate SopActionPerformService

==  执行取消动作 ==
SopActionPerformService -> OrderWriteService : cancelOrder
activate OrderWriteService
return boolean

== 添加动作记录(略) ==
return RpcResult<Void>
return RpcResult<Void>

@enduml
```

### 2.9 驿站添加白名单
主要请求path:`/addToStationWhiteList`;输入参数:caseId,HttpServletRequest。

```plantuml
@startuml
title 驿站添加白名单流程调用图

' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService
collections "CaseQueryService" as CaseQueryService
end box

box "alibaba.cainiao.stationplatform" #899
collections "StationBizUserTagService" as StationBizUserTagService
end box


' 开始流程
[o-> SopActionManager : addToStationWhiteList
activate SopActionManager
SopActionManager -> SopActionPerformService : addToStationWhiteList
activate SopActionPerformService
SopActionPerformService -> CaseQueryService : getCaseDetailByCaseId
activate CaseQueryService
return Result<CaseDetailInfo> 
SopActionPerformService -> StationBizUserTagService: setUserCollectIntention
activate StationBizUserTagService
return StationResultDTO<Void>
return Result<Void>
return RpcResult<Void>
@enduml
```


### 2.10 申请菜鸟介入
主要请求path:`/applyCnDealerStepIn`;输入参数caseId,taskId,memo,request

```plantuml
@startuml
title 申请菜鸟介入流程调用图

' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "ComplainCaseDealService" as ComplainCaseDealService
collections "CaseBizCheckManager" as CaseBizCheckManager
collections "CaseDealManager" as CaseDealManager
collections "CaseMapper" as CaseMapper
collections "ActionManager" as ActionManager

end box

' 开始流程
[o-> SopActionManager : applyCnDealerStepIn
activate SopActionManager
SopActionManager -> ComplainCaseDealService : applyCnDealerStepInJudge


activate ComplainCaseDealService
ComplainCaseDealService -> CaseBizCheckManager : checkSameCaseTask
activate CaseBizCheckManager
deactivate CaseBizCheckManager

ComplainCaseDealService -> CaseBizCheckManager : checkActiveTask
activate CaseBizCheckManager
deactivate CaseBizCheckManager

ComplainCaseDealService -> CaseDealManager : applyCnDealerStepIn
activate CaseDealManager
CaseDealManager -> CaseMapper : queryById
activate CaseMapper
return CaseDO

CaseDealManager -> CaseMapper: updateById
activate CaseMapper

note right of CaseMapper
更新任务状态
为完成
end note 
deactivate  CaseMapper
CaseDealManager -> CaseDealManager :completeBpmTask
activate CaseDealManager #958
deactivate CaseDealManager
' TODO 补充详细内容
note right of CaseDealManager
驱动流程
进行判断
详细内容后期补充
end note
' 新增动作节点
CaseDealManager -> ActionManager : addAction
note right of CaseDealManager
与addcallaction中相同
故省略
end note 
activate ActionManager
deactivate ActionManager

deactivate CaseDealManager
return Result<Boolean>

return RpcResult<Boolean>
@enduml
```

### 2.11 裹裹呼叫运力
主要请求路径`/callOutTransport`;输入参数caseId。

```plantuml
@startuml

title 裹裹呼叫运力流程简图
' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService
collections "CaseQueryManager" as CaseQueryManager
collections "TaskDAO" as TaskDAO
end box

box "cainiao.xq.client" #588
collections  "BottomTransportService" as BottomTransportService
end box

' 开始执行
[o-> SopActionManager : callOutTransport
activate SopActionManager
SopActionManager -> SopActionPerformService : callOutTransport
activate SopActionPerformService
SopActionPerformService -> CaseQueryManager : getCaseByCaseId
note over CaseQueryManager
查询单据
详细省略
end note
activate  CaseQueryManager
return CaseBaseInfo

SopActionPerformService -> TaskDAO : getCaseByCaseId
note over TaskDAO
查询任务
详细省略
end note
activate  TaskDAO
return TaskDO

' 执行呼叫运力
SopActionPerformService -> BottomTransportService : getURL
activate BottomTransportService
note over BottomTransportService
主要输入数据
来源
业务单据
账号类型
用户ID
end note
return Result<String>
note over SopActionPerformService
这里直接返回
裹裹的使用连接
相当于新页面跳出流程
end note 
return String

return RpcResult<String>

@enduml
```



### 2.12 加载留言模板 
主要请求路径:`/loadSpeechTemplateContent`;输入参数:templateId、caseId
```plantuml
@startuml

title 加载留言模板

' xspace
box xspace
collections "SopActionManager" as SopActionManager
end box
' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService
end box

box "gaea-platform" #LightBlue
collections "SpeechTemplateConfigService" as SpeechTemplateConfigService
collections "SpeechTemplateService" as SpeechTemplateService
end box


' 开始执行
[o-> SopActionManager : loadLeaveMessageTemplateContent
activate SopActionManager
SopActionManager -> SopActionPerformService : loadLeaveMessageTemplateContent
activate SopActionPerformService
' 获取留言配置模板
SopActionPerformService -> SpeechTemplateConfigService : getTemplateById
activate SpeechTemplateConfigService
note over SpeechTemplateConfigService
获取留言
配置模板
end note
return Result<SpeechTemplateDTO>

SopActionPerformService -> SpeechTemplateService : executeSpeechTemplate
activate SpeechTemplateService
note over SpeechTemplateService
获取留言
模板
end note
return Result<SpeechTemplateDTO>

return Result<SpeechTemplateDTO>

return RpcResult<String>

@enduml
```


### 2.13 结单（咨询工单完结）
主要请求路径:`/finishTask`;输入参数:caseDealEntity,sessionId,request

```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "CaseDealManager" as CaseDealManager1
end box

' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformServiceImpl" as SopActionPerformService
collections "ConsultCaseDealService" as ConsultCaseDealService
collections "CaseDealManager" as CaseDealManager2
collections "SopInteractiveService" as SopInteractiveService
end box

box "sopengine"
collections "SopRuntimeService" as SopRuntimeService
end box

'开始流程
[o-> SopActionManager : finishConsultCaseTaskWithinSop
activate SopActionManager
SopActionManager -> CaseDealManager1 :finishTask
activate CaseDealManager1

CaseDealManager1 -> ConsultCaseDealService : finishCase
activate ConsultCaseDealService
ConsultCaseDealService -> CaseDealManager2 : finishConsultCase
activate CaseDealManager2
deactivate CaseDealManager2


return Result<Void>
return RpcResult<Boolean>

SopActionManager -> SopInteractiveService : updateSopExecutionInstance
activate SopInteractiveService
SopInteractiveService -> SopRuntimeService : updateSopExecutionInstance
activate SopRuntimeService
return Result<Boolean>
return Result<Boolean>

return RpcResult<Boolean>
@enduml
```


### 2.14 申请SP小二介入

主要请求路径:`/transferToSpXiaoEr`;输入参数:caseId、taskId、sessionId、request

```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "TaskDealManager" as TaskDealManager
end box

' gaea-apllication
box "gaea-application" #LightGreen
collections "ConsultCaseDealService" as ConsultCaseDealService
collections "CaseQueryService" as CaseQueryService
collections "SopInteractiveService" as SopInteractiveService
collections "CaseDealManager" as CaseDealManager
end box

box "sopengine"
collections "SopRuntimeService" as SopRuntimeService
end box

'开始流程
[o-> SopActionManager : applyCnXiaoerDealerStepinWithinSop
activate SopActionManager

SopActionManager -> CaseQueryService:listActiveTaskByCaseId
activate CaseQueryService
note over CaseQueryService
获取处理
任务列表
end note
return Result<List<TaskInfo>>

SopActionManager -> SopActionManager:checkTaskInfo
activate SopActionManager #465
note right of  SopActionManager
确认用户
权限
end note
deactivate SopActionManager
' 获取订单详情
SopActionManager -> CaseQueryService : getCaseDetailByCaseId
activate CaseQueryService
note over CaseQueryService
获取
订单详情
end note
return Result<CaseDetailInfo>
SopActionManager -> TaskDealManager:transferToSpXiaoEr
activate TaskDealManager
note over TaskDealManager
任务转交
end note
TaskDealManager -> CaseQueryService : getTaskById
activate CaseQueryService
return Result<TaskInfo>
' 开始执行转交
TaskDealManager -> ConsultCaseDealService: applyContinueDeal
activate ConsultCaseDealService

ConsultCaseDealService -> CaseDealManager:applyContinueDeal
activate CaseDealManager
deactivate CaseDealManager

return Result<Void>

return RpcResult<Boolean>
SopActionManager -> SopInteractiveService: updateSopExecutionInstance
activate SopInteractiveService
SopInteractiveService -> SopRuntimeService: updateSopExecutionInstance
activate SopRuntimeService
return Result<Boolean>
note over SopRuntimeService
更新任务实例
状态为完成
end note

return  Result<Boolean>
return RpcResult<Boolean>
@enduml
```

### 2.15 预览发短信

`/previewText`

```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "TaskDealManager" as TaskDealManager
end box

' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformService" as SopActionPerformService
collections "CaseQueryManager" as CaseQueryManager
collections "SopActionPerformManager" as SopActionPerformManager
collections "CaseCommonDealManager" as CaseCommonDealManager
collections "NoticeManager" as NoticeManager
end box

box "gaea-platform"
collections "NoticeService" as NoticeService
collections "TemplateFactory" as TemplateFactory
collections "TemplateDAO" as TemplateDAO
end box

'开始流程
[o-> SopActionManager : previewText
activate SopActionManager

SopActionManager ->  CaseQueryManager : getCaseDetailInfoByCaseId
activate CaseQueryManager
note over CaseQueryManager
获取订单详细信息
省略
end note
return String orderCode
' 查找短信信息

SopActionManager -> SopActionPerformService : queryShortMessageObject
activate SopActionPerformService
SopActionPerformService -> SopActionPerformManager : getTextReceiverMobile
activate SopActionPerformManager
note over SopActionPerformManager
获取收信人手机号
详细过程省略
参看查询联系人方式中的
查询各种联系人方式
end note

return String
' 获取短信最终结果

SopActionPerformService -> SopActionPerformManager :getCompleteSmsTemplateContent
activate SopActionPerformManager

SopActionPerformManager -> NoticeManager : previewCompleteSmsContent
activate  NoticeManager
NoticeManager -> NoticeService : getRecordPreviewByManuallyTaskAndTemplateId
activate NoticeService

NoticeService -> TemplateFactory :loadTemplate
activate TemplateFactory
' 获取模板原始类型
TemplateFactory -> TemplateDAO : getTemplateById
activate TemplateDAO

return TemplateDO
TemplateFactory -> TemplateFactory : loadTemplateConfig
activate TemplateFactory #589
note right of TemplateFactory
主要是
配置参数的
提取
end note
deactivate TemplateFactory

return Template

return Result<RecordPreviewDTO>

return RecordPreviewDTO

return String
return Result<Map<String, String>>

' 执行公共处理
SopActionManager -> CaseCommonDealManager :convertContactDTOTOContactVO


activate CaseCommonDealManager
note over CaseCommonDealManager
主要对电话
等信息的脱敏
end note
return  ContactVO


return Map<String, String>
@enduml
```

### 2.16 sop内发起投诉动作
`/createComplain`
```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager

end box

' gaea-apllication
box "gaea-application" #LightGreen
collections "SopActionPerformService" as SopActionPerformService
collections "BizOrderManager" as BizOrderManager
collections "ComplainCaseCreateService" as ComplainCaseCreateService
collections "CompensateCaseCreateManager" as CompensateCaseCreateManager
collections "CaseDistinctDAO" as CaseDistinctDAO
collections "CaseDAO" as CaseDAO

end box


[o-> SopActionManager : createComplainWithinSop
activate SopActionManager
SopActionManager -> BizOrderManager : getBizOrderAttribute
activate BizOrderManager
note over BizOrderManager
获取业务单据
相关信息略
end note
return Map<String, Object>

SopActionManager -> ComplainCaseCreateService : createCaseByLogisticsOrder
activate ComplainCaseCreateService

ComplainCaseCreateService -> CompensateCaseCreateManager : createCase()
activate CompensateCaseCreateManager
note over CompensateCaseCreateManager
获取全量因子  
发/收货区域
end note 

' 
CompensateCaseCreateManager -> CompensateCaseCreateManager : assembleFactor
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 
note over CompensateCaseCreateManager
匹配业务线
end note 

CompensateCaseCreateManager -> CompensateCaseCreateManager : matchBizline
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
获取账号信息
end note

CompensateCaseCreateManager -> CompensateCaseCreateManager : assembleAccount
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
获取资源信息
end note 

CompensateCaseCreateManager -> CompensateCaseCreateManager : assembleResource
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
打标
end note

CompensateCaseCreateManager -> CompensateCaseCreateManager : makeTag
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
匹配创建规则
end note

CompensateCaseCreateManager -> CompensateCaseCreateManager : matchCreateRule
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
匹配分发规则和模板
end note

CompensateCaseCreateManager -> CompensateCaseCreateManager : matchDistributeRule
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
业务校验
end note

CompensateCaseCreateManager -> CompensateCaseCreateManager : checkBizRule
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager 

note over CompensateCaseCreateManager
实例化工单
end note

CompensateCaseCreateManager -> CompensateCaseCreateManager : instantiate
activate CompensateCaseCreateManager #567
deactivate CompensateCaseCreateManager

CompensateCaseCreateManager -> CaseDistinctDAO : insert
activate CaseDistinctDAO
deactivate

CompensateCaseCreateManager -> CaseDAO :insert
activate CaseDAO
return Long caseId
CompensateCaseCreateManager -> CaseDAO :insertExtFields
activate CaseDAO
deactivate CaseDAO
return Long caseId
return Result<Long>

' 返回的应该是投诉编号
return RpcResult<Long>

@enduml
```


### 2.17 查询裹裹允许修改的时间范围

请求路径:`/queryGuoguoAllowTime`

```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "BizOrderManager" as BizOrderManager
end box
' cainiao.tdtradeplatform
box "cainiao.tdtradeplatform" #LightGreen
collections "OrderWriteService" as OrderWriteService
end box

box "tdservicedisplay.industry.client" #589
collections "TdOrderEntryMtopService" as TdOrderEntryMtopService
end box

' 开始流程
[o-> SopActionManager : queryGuoguoAllowTime
activate SopActionManager

SopActionManager -> BizOrderManager : getBizOrder
activate BizOrderManager
note over BizOrderManager
获取订单详细信息
略
end note
return BizOrder
SopActionManager -> OrderWriteService : modifyOrderTime
activate OrderWriteService
note over OrderWriteService
获取裹裹
详细信息
end note
return Result<TxOrderDetailDTO>
SopActionManager -> TdOrderEntryMtopService: queryItemDetail
activate TdOrderEntryMtopService

note over OrderWriteService
获取货物
详细信息
end note

return Result<TdServiceDetailDTO>
return List<TimePeriodVO>
@enduml
```


### 2.18 修改裹裹上门时间
请求路径:`/modifyDropInTime`

```plantuml
@startuml

' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "BizOrderManager" as BizOrderManager
end box

' cainiao.tdtradeplatform
box "cainiao.tdtradeplatform" #LightGreen
collections "OrderWriteService" as OrderWriteService
end box

' 开始流程
[o-> SopActionManager : modifyDropInTime
activate SopActionManager
' 获取工单详细信息
SopActionManager -> BizOrderManager: getBizOrder
activate BizOrderManager
note over BizOrderManager
获取订单详细信息
略
end note
return BizOrder

SopActionManager -> OrderWriteService : modifyOrderTime
activate OrderWriteService
note over OrderWriteService
执行上门
时间修改
end note
return Result<Boolean>

return RpcResult<ModifyGuoguoDropInTimeResponseVO>

@enduml
```

### 2.19 驿站取消白名单

与添加白名单基本相同；故不做太多记录


### 2.20 转交cp
主要路径:/transferFlowToCp;主要的请求参数是caseId
应该是交给application 应用更改数据库的执行人权限。

```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "BizOrderManager" as BizOrderManager
end box

box "gaea-application" #Lightgreen
collections "CaseQueryService" as CaseQueryService
collections "ComplainCaseDealService" as ComplainCaseDealService
collections "CaseBizCheckManager" as CaseBizCheckManager
collections "OperationChain" as OperationChain
end box

' 开始流程
[o-> SopActionManager : transferFlowToCp
activate SopActionManager

SopActionManager -> CaseQueryService : listActiveTaskByCaseId
activate CaseQueryService
note over CaseQueryService
查询工单
活动任务信息
略
end note
SopActionManager -> ComplainCaseDealService :transferFlowToCp
activate ComplainCaseDealService
ComplainCaseDealService -> CaseBizCheckManager :checkSameCaseTask
activate CaseBizCheckManager
deactivate
ComplainCaseDealService -> CaseBizCheckManager :checkActiveTask
activate CaseBizCheckManager
deactivate

alt 在星云处理流程中
ComplainCaseDealService -> OperationChain :Result
activate OperationChain
note over OperationChain
执行职责链
(需要进一步细化)
end note
return Result
end alt

return Result<Boolean>
return Result<List<TaskInfo>>

return RpcResult<Void>
@enduml
```


### 2.21 评价sop
主要请求路径:`/evaluateSop`;
```plantuml
@startuml
' xspace
box xspace
collections "SopActionManager" as SopActionManager
collections "BizOrderManager" as BizOrderManager
end box
 
box "gaea.application" #299
collections "SopSatisfactionService" as SopSatisfactionService
collections "SopSatisfactionManager" as SopSatisfactionManager
collections "SopSatisfactionDAO" as  SopSatisfactionDAO
end box

' 开始流程
[o-> SopActionManager : evaluateSop
activate SopActionManager

SopActionManager -> SopSatisfactionService : evaluateSop
activate SopSatisfactionService
SopSatisfactionService -> SopSatisfactionManager : evaluateSop
activate SopSatisfactionManager
SopSatisfactionManager -> SopSatisfactionDAO : insert
activate SopSatisfactionDAO
note over SopSatisfactionDAO
在这里
插入数据库
end note
deactivate SopSatisfactionDAO

deactivate SopSatisfactionManager

return Result<Void>

return RpcResult<Void>
@enduml
```



### 2.22 获取sop不满意类型
主要请求路径:`/getSopDownVoteType`
直接输出`SopDownVoteTypeEnum`枚举类中数据。无太多调用


### 2.23 发送留言信息

主要请求路径:`/caseDeal/newMessage`

```plantuml
@startuml
title 发送留言信息关键时序图
box xspace
collections "CaseDealController" as CaseDealController
collections "CaseDealManager" as CaseDealManager

end box

box gaea.platfrom #586
collections "BaseDealService" as BaseDealService
collections "AddNewMessageFactor" as AddNewMessageFactor
collections "OperationChain" as OperationChain
end box

'开始流程
[o-> CaseDealController : addNewMessage
activate CaseDealController

CaseDealController -> CaseDealManager : addNewMessage
activate CaseDealManager

CaseDealManager -> BaseDealService : addNewMessage
activate BaseDealService

BaseDealService -> AddNewMessageFactor: buildByHardCode
activate AddNewMessageFactor
return OperationChain
BaseDealService -> OperationChain:doOperation
activate OperationChain
note over OperationChain
执行操作链
end note
deactivate OperationChain

return Result<Boolean>

return RpcResult<Boolean> result

return RpcResult<Boolean>
@enduml
```

### 2.24 获取技能组

主要请求路径：`listXSpaceTransferSkillGroup`

```plantuml
@startuml
box xspace
collections "TaskDealManager" as TaskDealManager

end box
box gaea-application #LightBlue 
collections "BackDoorService" as BackDoorService
collections "XspaceToSpSkillGroupConfig" as XspaceToSpSkillGroupConfig
end box

box gaea-platfrom #LightGreen
collections "GroupManageService" as GroupManageService
collections "GroupMapper" as GroupMapper
end box

' 开始流程
[o->TaskDealManager: listXSpaceTransferSkillGroup
activate TaskDealManager
TaskDealManager -> BackDoorService :listXSpaceTransferSkillGroup
activate BackDoorService
BackDoorService -> XspaceToSpSkillGroupConfig :getSkillGroupMap
activate XspaceToSpSkillGroupConfig
note over XspaceToSpSkillGroupConfig
这里是通过
Diamond进行
数据的获取
end note

return List<Long>
loop id : List<Long>
BackDoorService -> GroupManageService:getGroupById
activate GroupManageService
GroupManageService -> GroupMapper:selectByPrimaryKey
activate GroupMapper
return Group
return Result<Group>
end loop
note over GroupManageService
获取技能组
详细信息
end note
return Result<List<SkillGroup>>

return  RpcResult<List<SkillGroup>>
@enduml
```


## 3 主要动作流程和请求发送

### 3.0 SOP判责助手
主要步骤:
1. 点击SOP判责按钮
2. 查询SOP评价信息:`action/getSopDownVoteType`
3. 展示播放界面:`sopPlay/play`


### 3.1 留言
主要步骤如下
1. 获取用户账号信息:`/getOutBound`
2. 获取留言模板:`/action/loadSpeechTemplateContent`
3. 点击发送留言信息:`/caseDeal/newMessage`执行留言


### 3.2 外呼

外呼这里有两个主要动作：
1. 获取外呼号码:`action/getOutBound`
2. 进行外呼和转接:`action/call`；注意x-space中这里并没有执行
3. 添加外呼动作记录:`action/addCallAction`

注意:这里的外呼节点存在问题：

SOP播放内的外呼只有`action/addCallAction`,并没有调用`action/call`
SOP外的外呼是调用`caseCommonDeal/outBoundCallExecute`

SOP播放中的应该没有执行`call`只是添加了一次记录。所以外呼是真的打出去了吗。

外面的外呼按钮主要动作有:
1. 页面加载时获取外呼信息:`caseCommonDeal/getOutBound`
2. 执行外呼:`caseCommonDeal/outBoundCallExecute`

### 3.3 发短信
1. 获取短信模板:`action/previewText`
2. 获取收信人列表:`action/listTextReceiver`
3. 发送短信:`action/text`

### 3.4 采纳SOP判责结论



### 3.5 不采纳SOP判责结论



### 3.6 代叫运力(裹裹呼叫运力)
1. 运力调度:`action/callOutTransport`


### 3.7 取消裹裹订单
1. 直接取消订单:`action/cancelGuoguo`


### 3.8 申请菜鸟小二介入
1. 确认任务技能组: `taskDeal/checkGetSkillGroup`
2. 技能组列表:`action/listXSpaceTransferSkillGroup`
3. 点击确定：申请小二介入:`actions/transferToSpXiaoEr`

注意:在cdesk中直接确认就好；没有技能组选项。

### 3.9 咨询工单完结
1. 获取留言模板:`/action/loadSpeechTemplateContent`
2. 点击确认咨询完结工单:`/action/finishTask`
3. 咨询完结工单的上传附件:
   1. `common/getOssTempPolicy`
   2. `https://56newroute.oss-cn-shanghai.aliyuncs.com/`

注意:这里点击之后就是工单完结；之后交给流程引擎来处理。但是100%返回成功。

### 3.10 工单挂起

1. 获取挂起信息:`taskDeal/listRemindType`
2. 点击确定执行:`taskDeal/setReminder`

### 3.11  发起投诉
1. 点击发起投诉按钮；获取订单信息和支持的投诉类型:
   1. 获取物流订单号:通过caseDeatial获取
   2. 投诉方:`com.cainiao.gaea.platform.spi.common.constant.CustomerRoleEnum`
    ```java
    /* 消费者(买家) */
    CONSUMERS(DictionaryConstants.ROLE_CONSUMERS, "买家"),
    /*商家 */
    SELLER(DictionaryConstants.ROLE_SELLER, "商家"),
    /*菜鸟合作伙伴*/
    CP(DictionaryConstants.ROLE_CP, "菜鸟合作伙伴"),

    OTHER(DictionaryConstants.ROLE_OTHERS,"其它");
    ```
   3. 服务类型:
   4. 投诉原因:memo
   5. 上传凭证:附件链接
2. 点击确定:`/createComplain`发送投诉

问题：如何获取业务投诉类型bizType列表


### 3.12 修改上门时间
1. 点击修改上门时间:查询可以上门时间:`action/queryGuoguoAllowTime`
2. 选择时间，点击确认:`action/modifyDropInTime`


### 3.13 添加驿站白名单


### 3.14 取消驿站白名单


### 3.15 下发CP举证


### 存在问题记录


1. 其中的应用名称需要修改
2. 云小二角色使用适配器模式来进行修改
3. 发起sop内投诉角色是小二。
4. TxOrder是什么
5. 流程转交到CP的时候；中的CaseDealManager中的transferFlowToCp中的代码段是否成立；什么情况下不会成立；条件有哪些？
6. CaseDealManager中的职责链处理需要重点查看
7. SOP不满意类型；直接在枚举类中定义SopDownVoteTypeEnum，不方便扩展
8. SOP播放内的外呼只有`action/addCallAction`,并没有调用`action/call`；SOP外的外呼是调用`caseCommonDeal/outBoundCallExecute`；SOP播放中的应该没有执行`call`只是添加了一次记录。所以外呼是真的打出去了吗
9.  代叫运力中，点击之后直接弹出新页面；操作完全在另外的页面进行；因此没有任何记录
10. 点击咨询完结工单；出现结单选项。但是出现备注为模板。具体字段如下
```
已运力调度，下单信息为${gaeaBizOrderCode}，接单小件员电话为${deliveryUserPhone}，预计上门时间为${expectDoorTime}，取件码为${pickUpCode}
```
11. 咨询工单完结之后，是马上处于完结状态，还是需要另外判断？？？
12. Xsapce中的申请小二介入中的技能组是；云小二专有的；是否需要根据角色进行适配
13. Xspace中的TaskDealManager中的`listXSpaceTransferSkillGroup` 使用了过时的方法（舒爽）
    1.  **解决方案: 使用cdesk中的申请小二记录的工单记录。**
14. gaea-application中的XspaceToSpSkillGroupConfig中的getDataId基本写死为`XSPACE_TO_SP_SKILL_GROUP_DIAMOND_DATAID`是否正常。
15. 外呼因为是和云小二绑定的，因此SOP中的外呼热线号码固定。所以如何获取非固定的热线号码接口。
16. 


### 需要注意的地方
1. BaseDealService 中的addNewMessage中抽象类的处理
2. Cdesk中用户角色的过滤；进行

## 主要设计方案
### 1. 主要面对问题
1. 不同的动作对于不同的角色，可能存在不同的显示和执行；可能不同，前端渲染可能也不同。
2. 解决方式:使用策略模式,根据角色的不同使用不同的调用方法。
   1. 使用公共默的抽象类实现基本一般的函数通用函数
   2. 对于不同的角色在使用Manager进行控制的时候进行判断。
   3. 在controller层对用户的角色进行判断，然后使用工厂生成不同的对象和类。
   4. 这里使用静态模式进行策略模式工厂([参考](https://www.jianshu.com/p/5ccf1706297d))
   5. 对于新的角色，只需要继承抽象类，并直接对不同的函数进行重载就可以了。
3. 注意cdesk中的基础服务调用中，自带动作记录。因此需要注意。


### cdesk中现在支持的动作组件

- 完结工单:`confirmFinish`
- 申请菜鸟小二介入:`cnDealerStepIn`
- 执行成功:`success`
- 判责成立:`judgeTrue`
- 判责不成立:`judgeFalse`
- 完结:`finish`
- CP认则不认赔
- CP成立非我则
- CP成立非我全则
- CP认则类型不一致
- CP认则认赔
- CP不忍责
- 要求继续处理
- 确认完结:`structFinish`
- CP举证:
- 代叫运力


处理组件列表:

|名称|code|Action|预发校验(是否存在)|
|:---:|:---:|:---|:---:|
|留言|`addNewMessage`|执行成功|是|
|提醒|`remind`|执行成功|是|
|工单撤销|`caseCanncel`|执行成功|否|
|申请菜鸟小二介入|`applyCnDealerStepIn`|申请菜鸟小二介入|是|
|系统外呼|`outBoundCall`|执行成功|是|
|转交|`caseTransfer`|执行成功|是|
|判责|`judge`|判责成立，判责不成立|是|
|sku判责|`judgeCaseByCpWithSku`|判责成立/判责不成立|是|
|定则定损|`warlordCpJudgeAndValue`|CP不认责,CP认责|是|
|继续处理|`continueDeal`|要求继续处理|是|
|确认结单|`confirmFinish`|确认完结|是|
|工单完结(结单)|`caseFinish`|工单完结，完结|是|
|结构化结单(结单)|`structFinish`|执行成功||
|申通测试处理组件|`TestSTOFunction1`|执行成功||
|工单拦截(拦截)|`caseIntercept`|完结||
|统一判责(定责)|`generalJudge`|判责成立，判责不成立||
|批量成立|`batchJudge`|判责成立||
|智能语音外呼(智能外呼)|`SmartCall`|执行成功||
|CP举证|`cpProof`|CP举证||
|工单挂起|`caseHangUp`|执行成功||
|任务申领|`taskApply`|执行成功||
|代叫运力|``|||
|承诺解决时间|`promiseSloveTime`|完结工单||
|异常原因确认|`errorConfirm`|完结工单||


|名称|类型|优先级|完成状况|测试状况|
| --- | --- | --- | --- | --- |
|采纳SOP判责结论|SOP|高|完成||
|不采纳SOP判责结论|SOP|高|完成||
|咨询完结工单|SOP|高|完成||
|申请菜鸟小二介入|SOP|高|完成||
|工单挂起|SOP||完成(获取提醒类型由前端获取)||
|留言|SOP||完成|成功|
|外呼|SOP||完成||
|发起投诉|SOP||完成||
|发短信|SOP||完成|成功|
|代叫运力(裹裹呼叫运力)|SOP||完成|成功|
|添加驿站白名单|SOP||完成||
|取消驿站白名单|SOP||完成||
|取消裹裹订单|SOP||完成|失败，总是返回false；orderWriteService异常|
|修改上门时间|SOP||完成||
|下发CP举证|SOP||||

sop播放: 测试成功
sopmetch:测试成功


获取sku信息

function/structJudge/getSkuMessage

**取消驿站白名单，使用的是驿站ID**

查询裹裹上门时间只有LP单才可以

m.cainiao.gaea.cdesk.cainiao.biz.manager.sop.impl.SopPlayManagerImpl.matchSop checkAndGetCurrentUserTaskInfo Failed;message:User is all 没有权限

package com.cainiao.xq.client.ability;

import com.cainiao.xq.client.basebean.Result;
import com.cainiao.xq.client.request.BottomTransportRequest;

public interface BottomTransportService {
    Result<Boolean> getIsShow(BottomTransportRequest var1);

    Result<String> getURL(BottomTransportRequest var1);
}
```java
 // 呼叫裹裹运力
public String callOutTransport(Long caseId) {

        CaseBaseInfo caseBaseInfo = caseQueryManager.getCaseByCaseId(caseId);
        String bizOrderCode = caseBaseInfo.getBizOrderCode();
        TaskDO taskDO = taskDAO.queryCurrentActiveTaskByCaseId(caseId);

        BottomTransportRequest bottomTransportRequest = new BottomTransportRequest();
        //来源
        bottomTransportRequest.setSource(XSPACE);
        //业务单据
        bottomTransportRequest.setBizCode(bizOrderCode);
        //账号类型
        bottomTransportRequest.setAccoutType(UIC);
        //用户ID
        bottomTransportRequest.setUserId(taskDO.getDealerId());

        //调用小乔的获取呼叫运力的URL
        com.cainiao.xq.client.basebean.Result<String> result = bottomTransportService.getURL(bottomTransportRequest);
        if (!result.isSuccess() || result.getData() == null) {
            logger.error("bottomTransportService Failed to getURL, caseId={}", caseId, result.getDetailMsg());
            throw new InvokeFailedBizException("bottomTransportService Failed to getURL" + result.getDetailMsg());
        }
        return result.getData();
        // 为什那么没有加动作记录？没有这个动作

}
```